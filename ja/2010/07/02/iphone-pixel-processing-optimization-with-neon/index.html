<!DOCTYPE html>
<html lang="ja" ng-app="App" ng-controller="MainController">
  <head>
    <link href='http://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>iPhoneでのピクセル処理をNEON(ベクタ演算)を使って4倍高速化する</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">        
    <meta name="description" content="Moonshine Project official website
">
    <link rel="canonical" 
          href="http://moonshine-project.com//ja/2010/07/02/iphone-pixel-processing-optimization-with-neon/">
    <link rel="shortcut icon" href="/assets/images/favicon.png">
    
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/bower_components/foundation/css/normalize.css">
    <link rel="stylesheet" href="/bower_components/angular-material/angular-material.css">
    <link rel="stylesheet" href="/bower_components/angular-material/themes/deep-purple-theme.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">

    <!-- Modernizr js -->
    <script async src="/bower_components/modernizr/modernizr.js"></script>

    <!-- IE Fixes -->
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->        
  </head>
  <body layout="horizontal" md-theme="deep-purple">
    <md-sidenav layout="vertical" component-id="left" class="md-sidenav-left md-whiteframe-z2" id="footered-sidenav" is-locked-open="$media('md')">
      <md-toolbar class="md-medium-tall" id="footered-sidenav-toolbar"></md-toolbar>
      <md-content layout="vertical" class="footered-sidenav-content">
        

  
    <a class="sidenav-item" href="http://moonshine-project.com//ja/archive/">ブログアーカイブ</a>
  

  
    <a class="sidenav-item" href="http://moonshine-project.com//ja/projects/">プロジェクト</a>
  

  
    <a class="sidenav-item" href="http://moonshine-project.com//ja/workstyle/">ワークスタイル</a>
  


        <div flex></div>
        <footer>
          <h2>Follow me</h2>


<h3>@akiraak</h3>
  <ul class="social-media">
    
    <li>
        <a title="akiraak on Github" 
           href="https://github.com/akiraak" 
           class="fi-social-github"><span class="fontawesome-text">Github</span></a>
    </li>
     
    
    <li>
        <a title="akira.kozakai on Facebook" 
           href="https://facebook.com/akira.kozakai" 
           class="fi-social-facebook"><span class="fontawesome-text">Facebook</span></a>
    </li>
    
    
    <li>
        <a title="akiraak on Twitter" 
           href="https://twitter.com/akiraak" 
           class="fi-social-twitter"><span class="fontawesome-text">Twitter</span></a>
    </li>
    
    
    
</ul>

<h3>@ento</h3>
  <ul class="social-media">
    
    <li>
        <a title="ento on Github" 
           href="https://github.com/ento" 
           class="fi-social-github"><span class="fontawesome-text">Github</span></a>
    </li>
     
    
    <li>
        <a title="entotto on Facebook" 
           href="https://facebook.com/entotto" 
           class="fi-social-facebook"><span class="fontawesome-text">Facebook</span></a>
    </li>
    
    
    <li>
        <a title="ento on Twitter" 
           href="https://twitter.com/ento" 
           class="fi-social-twitter"><span class="fontawesome-text">Twitter</span></a>
    </li>
    
    
    <li>
        <a title="+MaricaOdagaki on Google Plus" 
           href="https://plus.google.com/+MaricaOdagaki" 
           class="fi-social-google-plus"><span class="fontawesome-text">Google</span></a>
    </li>
    
    
    <li>
        <a title="maricaodagaki on LinkedIn" 
           href="https://linkedin.com/in/maricaodagaki" 
           class="fi-social-linkedin"><span class="fontawesome-text">LinkedIn</span></a>
    </li>
    
</ul>

  

          <p class="attribution"><a href="https://github.com/moonshine-project/moonshine-project.github.io#Colophon">Colophon</a></p>

        </footer>
      </md-content>
    </md-sidenav>
    <div layout="vertical" layout-fill role="main">
      <md-toolbar class="md-medium-tall">
        <header>
          <div class="md-toolbar-tools content-container">
            <button class="menu-icon" hide-md aria-label="Open Menu" ng-click="openMenu()">
              <span class="fi-list"></span>
            </button>
            <h1><a href="/">Moonshine Project</a></h1>
            <h2></h2>
            <span flex></span>
            

          </div>
        </header>
      </md-toolbar>
      <md-content ng-view scroll-y flex>
        <div class="content-container">
          <div class="page-content">
  <div class="post">
    <h1>iPhoneでのピクセル処理をNEON(ベクタ演算)を使って4倍高速化する</h1>
    <div class="post-meta">02 Jul 2010 / akira /
      <span class="label secondary radius">開発</span>
    </div>
    <hr/>
    <div class="post-content">
      <h2>目次</h2>

<ul>
<li>はじめに</li>
<li>どのような処理をするのか？</li>
<li>コードの入手先</li>
<li>C言語でのコード</li>
<li>アセンブラでのコードとgccの最適化の素晴らしさ</li>
<li>NEON : 資料</li>
<li>NEON : 処理の流れと制限</li>
<li>NEON : コード</li>
<li>NEON : コード解説-処理限界数でのループ</li>
<li>NEON : コード解説-レジスタの役割</li>
<li>NEON : コード解説-データの読込</li>
<li>NEON : コード解説-加算</li>
<li>NEON : コード解説-ピクセルの色チェックとカウント</li>
<li>NEON : コード解説-カウントの合計</li>
<li>終りに</li>
</ul>

<h2>はじめに</h2>

<p><a href="http://www.flickr.com/photos/akiraak/4750774211/"><img src="http://farm5.static.flickr.com/4076/4750774211_df1f5564f8_o.png" alt="IMG_0001"></a>
ARMのNEONというベクタ演算を使ってコードを書いたところ、C言語で書いたコードの４倍の速度で動作する事ができました。この記事では、C言語でのコードの紹介、アセンブラでのコードの紹介、そしてNEONを利用したコードの紹介を行い、高速化を実現させた手法を書きます。</p>

<h2>どのような処理をするのか？</h2>

<p><a href="http://itunes.apple.com/jp/app/id351820519?mt=8">
<img src="/ja/files/2010/02/nvv1_icon_reflection_96x100.png" alt="吾輩の小説">
</a></p>

<p>弊社からリリースしている自炊系読書アプリ<a href="http://itunes.apple.com/jp/app/id351820519?mt=8">「吾輩の小説 for iPhone」</a>は、画像のピクセルを全てチェックして文章を整形して表示しています。この処理がとても重いので最適化の一貫として研究した情報を公開します。</p>

<p>このプログラムでは 1024x768 ピクセルでRGBAのフォーマットをもつデータから、RGBの各色の合計値が256未満であるピクセルの数を計算します。つまり、画像データから黒っぽいピクセルがいくつあるのかを計算します。また、計算速度の違いが分かりやすくなるように、これを100回繰り返し合計で約8000万ピクセルの計算を行ないます。また、その計算時間を表示します。</p>

<h2>コードの入手先</h2>

<p><a href="http://github.com/akiraak/neon-pixeltest-for-iphone">github</a>にプロジェクトファイルも含めてiPhoneで実行できるファイル一式をアップしましたのでご利用ください。gitコマンドを使用しない場合は<a href="http://github.com/akiraak/neon-pixeltest-for-iphone/downloads">こちら</a>からzip化したものを落としてください。</p>

<h2>C言語でのコード</h2>

<p>以下がコードになります。</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define IMAGE_SIZE_W        (1024)</span>
<span class="cp">#define IMAGE_SIZE_H        (768)</span>
<span class="cp">#define CHECK_COLOR     (0xFF)</span>
<span class="cp">#define LOOP_COUNT      (100)</span>
<span class="cp">#define ELEMENT_OF_PIXEL    (4)</span>

<span class="n">NSString</span><span class="o">*</span> <span class="n">Test</span><span class="o">::</span><span class="n">testC</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">pixelCount</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">hitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LOOP_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">imageWork</span> <span class="o">=</span> <span class="n">image</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pixelCount</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
            <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="n">imageWork</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">imageWork</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">imageWork</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="n">color</span> <span class="o">&lt;</span> <span class="n">CHECK_COLOR</span><span class="p">){</span>
                <span class="n">hitCount</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">imageWork</span> <span class="o">+=</span> <span class="n">ELEMENT_OF_PIXEL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>
    <span class="n">NSString</span><span class="o">*</span> <span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="err">@</span><span class="s">&quot;Pixel: %d</span><span class="se">\n</span><span class="s">Hit Pixel: %d</span><span class="se">\n</span><span class="s">Time: %d msec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixelCount</span> <span class="o">*</span> <span class="n">LOOP_COUNT</span><span class="p">,</span> <span class="n">hitCount</span><span class="p">,</span> <span class="n">endTime</span><span class="o">-</span><span class="n">startTime</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>RGBの合計値を算出し、CHECK_COLOR(0xFF) よりも小さいものをカウントしていくだけのシンプルなプログラムです。</p>

<h2>アセンブラでのコードとgccの最適化の素晴らしさ</h2>

<p>以下がコードになります。</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define IMAGE_SIZE_W        (1024)</span>
<span class="cp">#define IMAGE_SIZE_H        (768)</span>
<span class="cp">#define CHECK_COLOR     (0xFF)</span>
<span class="cp">#define LOOP_COUNT      (100)</span>
<span class="cp">#define ELEMENT_OF_PIXEL    (4)</span>

<span class="n">NSString</span><span class="o">*</span> <span class="n">Test</span><span class="o">::</span><span class="n">testAsm</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">pixelCount</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">hitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">checkColor</span> <span class="o">=</span> <span class="n">CHECK_COLOR</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LOOP_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">__asm__</span> <span class="k">volatile</span> <span class="p">(</span>
                <span class="s">&quot;mov    r0, #0 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="c1">// ループ開始</span>
                <span class="s">&quot;1: </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;add    r0, r0, #1 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="s">&quot;ldrb   r3, [%[image]] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;ldrb   r2, [%[image], #1] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;add    r2, r2, r3  </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="s">&quot;ldrb   r3, [%[image], #2] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;add    r2, r2, r3  </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;add    %[image], %[image], #4  </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="c1">// 色判定とカウント</span>
                <span class="s">&quot;cmp    r2, %[checkColor] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;addlt %[hitCount], %[hitCount], #1 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="c1">// 「ループ開始」へ戻る</span>
                <span class="s">&quot;cmp    r0, %[pixelCount] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;bne    1b </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="o">:</span> <span class="p">[</span><span class="n">hitCount</span><span class="p">]</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">hitCount</span><span class="p">)</span>
                <span class="o">:</span> <span class="p">[</span><span class="n">pixelCount</span><span class="p">]</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">pixelCount</span><span class="p">),</span> <span class="p">[</span><span class="n">image</span><span class="p">]</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="p">[</span><span class="n">checkColor</span><span class="p">]</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">checkColor</span><span class="p">)</span>
                <span class="o">:</span> <span class="s">&quot;r0&quot;</span><span class="p">,</span> <span class="s">&quot;r1&quot;</span><span class="p">,</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;r3&quot;</span><span class="p">,</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span>
                <span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>
    <span class="n">NSString</span><span class="o">*</span> <span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="err">@</span><span class="s">&quot;Pixcel: %d</span><span class="se">\n</span><span class="s">Hit Pixel: %d</span><span class="se">\n</span><span class="s">Time: %d msec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixelCount</span> <span class="o">*</span> <span class="n">LOOP_COUNT</span><span class="p">,</span> <span class="n">hitCount</span><span class="p">,</span> <span class="n">endTime</span><span class="o">-</span><span class="n">startTime</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>時間を計測したところ、驚くことに C言語 で書いたものよりも速度が遅くなりました。gccがCからアセンブラにコンパイルする時の最適化がとても優れているのだと思います。NEONなどの特殊な機能を使わないかぎりは、アセンブラ化せず C言語 で書くほうが良いと思います。</p>

<h2>NEON : 資料</h2>

<p>今回のコードでお見苦しい点があればご容赦願います。アセンブラでの開発経験が全く無く2日前に勉強しながら作成したものです。そこで、使用した資料を列挙しておきます。</p>

<ul>
<li><a href="http://www.mztn.org/slasm/arm00.html"><strong>ARM アセンブリ</strong></a><br>
ARMの基本的なプログラミングの手法を知る事ができます。</li>
<li><a href="http://www32.atwiki.jp/nakamura001/?page=%E3%83%88%E3%83%83%E3%83%97%E3%83%9A%E3%83%BC%E3%82%B8/iPhone/%E3%82%A4%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%B3%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%A9"><strong>iPhoneでインラインアセンブラを使う</strong></a><br>
iPhoneでアセンブラを使用する時の手法を知る事ができます。</li>
<li><a href="http://wlog.flatlib.jp/item/1408"><strong>ARM Cortex-A8 の NEON と浮動小数演算最適化</strong></a><br>
<a href="http://wlog.flatlib.jp/item/1401"><strong>NetWalker PC-Z1 Cortex-A8 (ARM) 浮動小数演算の実行速度</strong></a><br>
NEONのレジスタや計算の雰囲気を知ることができます。</li>
<li><a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0204ij/index.html"><strong>RealView® Compilation Tools アセンブラガイド バージョン 4.0</strong></a><br>
ARM命令が網羅されているリファレンスです。ただし、バージョンが古いせいか今回使用している一部の命令は載っていません。</li>
<li><a href="http://blogs.arm.com/software-enablement/coding-for-neon-part-1-load-and-stores/"><strong>Coding for NEON - Part 1: Load and Stores</strong></a><br>
メモリからNEONレジスタにデータを読み込む時の参考になる資料です。</li>
</ul>

<h2>NEON : 処理の流れと制限</h2>

<p>NEONはベクタ演算です。ベクタ演算とは復数の演算を１命令で実行します。今回の方法では、１６回の足し算、１６回の比較などを１命令で実行します。それにともなって、今までの単純なループや比較ではなくて、それなりに複雑なプログラムになってきます。処理の大まかな流れは以下の順番になります。</p>

<ol>
<li><p>16ピクセル(64バイト)分のデータを詠込む</p></li>
<li><p>16ピクセルのRGBを一気に足す</p></li>
<li><p>16ピクセルの0xFF未満の値を一気にカウンタに追加</p></li>
<li><p>4096ピクセルの処理が終わるまで1-3を繰返す</p></li>
<li><p>カウンタの合計を取る</p></li>
<li><p>全てのピクセルの処理が終わるまで1-5を繰返す</p></li>
</ol>

<p>ポイントは「16ピクセルを一気に処理」している所と、「4096ピクセルの処理」を一つの境目としている所です。以下で詳しく説明していきます。</p>

<h2>NEON : コード</h2>

<p>以下がコードになります。</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define IMAGE_SIZE_W        (1024)</span>
<span class="cp">#define IMAGE_SIZE_H        (768)</span>
<span class="cp">#define CHECK_COLOR         (0xFF)</span>
<span class="cp">#define LOOP_COUNT          (100)</span>
<span class="cp">#define ELEMENT_OF_PIXEL    (4)</span>

<span class="n">NSString</span><span class="o">*</span> <span class="n">Test</span><span class="o">::</span><span class="n">testNeon</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">pixelCount</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">innerLoop</span> <span class="o">=</span> <span class="p">((</span><span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="p">)</span><span class="o">/</span><span class="n">pixelCount</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">totalHitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">checkColor</span> <span class="o">=</span>
        <span class="n">CHECK_COLOR</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
        <span class="n">CHECK_COLOR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
        <span class="n">CHECK_COLOR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
        <span class="n">CHECK_COLOR</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addMask</span> <span class="o">=</span> <span class="mh">0x01010101</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LOOP_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_image</span> <span class="o">=</span> <span class="n">image</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">innerLoop</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
            <span class="kt">int</span> <span class="n">hitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">__asm__</span> <span class="nf">volatile</span> <span class="p">(</span>
                    <span class="c1">// 初期化</span>
                    <span class="s">&quot;mov    r0, #0 </span><span class="se">\n\t</span><span class="s">&quot;</span> <span class="c1">// 0クリア用</span>
                    <span class="s">&quot;mov    r1, #0 </span><span class="se">\n\t</span><span class="s">&quot;</span> <span class="c1">// 処理済みピクセルのカウンタ</span>
                    <span class="s">&quot;vmov.u32 d8, r0, r0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vmov.u32 d9, r0, r0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vmov.u32 d10, %[checkColor], %[checkColor] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vmov.u32 d11, %[checkColor], %[checkColor] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vmov.u32 d12, %[addMask], %[addMask] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vmov.u32 d13, %[addMask], %[addMask] </span><span class="se">\n\t</span><span class="s">&quot;</span>

                    <span class="c1">// ループ開始</span>
                    <span class="s">&quot;1: </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;add    r1, r1, #16 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                    <span class="c1">// データの読込と色の加算</span>
                    <span class="s">&quot;add        r2, %[image], #32 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vld4.8 {d0, d2, d4, d6}, [%[image]] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vld4.8 {d1, d3, d5, d7}, [r2] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vqadd.u8   q0, q1 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vqadd.u8   q0, q2 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                    <span class="c1">// 色の判定とカウント</span>
                    <span class="s">&quot;vclt.u8 q1, q0, q5 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vand q1, q6 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vadd.u8 q4, q4, q1 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                    <span class="c1">// データのアドレスを進める</span>
                    <span class="s">&quot;add    %[image], #64 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                    <span class="c1">// 「ループ開始」へ</span>
                    <span class="s">&quot;cmp    r1, %[pixelCount] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;bcc    1b </span><span class="se">\n\t</span><span class="s">&quot;</span>

                    <span class="c1">// 色数の合計</span>
                    <span class="s">&quot;mov    r0, #0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vmov.u32   r1, d8[0] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;2: </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;and        r2, r1, #0xFF </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;add        %[hitCount], r2 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;lsr        r1, #8 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;add        r0, #1 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;cmp        r0, #4 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;bne        2b </span><span class="se">\n\t</span><span class="s">&quot;</span>

                    <span class="s">&quot;mov    r0, #0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vmov.u32   r1, d8[1] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;3: </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;and        r2, r1, #0xFF </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;add        %[hitCount], r2 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;lsr        r1, #8 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;add        r0, #1 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;cmp        r0, #4 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;bne        3b </span><span class="se">\n\t</span><span class="s">&quot;</span>

                    <span class="s">&quot;mov    r0, #0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vmov.u32   r1, d9[0] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;4: </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;and        r2, r1, #0xFF </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;add        %[hitCount], r2 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;lsr        r1, #8 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;add        r0, #1 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;cmp        r0, #4 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;bne        4b </span><span class="se">\n\t</span><span class="s">&quot;</span>

                    <span class="s">&quot;mov    r0, #0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;vmov.u32   r1, d9[1] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;5: </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;and        r2, r1, #0xFF </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;add        %[hitCount], r2 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;lsr        r1, #8 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;add        r0, #1 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;cmp        r0, #4 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                    <span class="s">&quot;bne        5b </span><span class="se">\n\t</span><span class="s">&quot;</span>

                    <span class="o">:</span> <span class="p">[</span><span class="n">hitCount</span><span class="p">]</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">hitCount</span><span class="p">)</span>
                    <span class="o">:</span> <span class="p">[</span><span class="n">pixelCount</span><span class="p">]</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">pixelCount</span><span class="p">),</span> <span class="p">[</span><span class="n">image</span><span class="p">]</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">_image</span><span class="p">),</span> <span class="p">[</span><span class="n">checkColor</span><span class="p">]</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">checkColor</span><span class="p">),</span> <span class="p">[</span><span class="n">addMask</span><span class="p">]</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addMask</span><span class="p">)</span>
                    <span class="o">:</span> <span class="s">&quot;r0&quot;</span><span class="p">,</span> <span class="s">&quot;r1&quot;</span><span class="p">,</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;q0&quot;</span><span class="p">,</span> <span class="s">&quot;q1&quot;</span><span class="p">,</span> <span class="s">&quot;q2&quot;</span><span class="p">,</span> <span class="s">&quot;q3&quot;</span><span class="p">,</span> <span class="s">&quot;q4&quot;</span><span class="p">,</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span>
                    <span class="p">);</span>
            <span class="n">totalHitCount</span> <span class="o">+=</span> <span class="n">hitCount</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>
    <span class="n">NSString</span><span class="o">*</span> <span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="err">@</span><span class="s">&quot;Pixcel: %d</span><span class="se">\n</span><span class="s">Hit Pixel: %d</span><span class="se">\n</span><span class="s">Time: %d msec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">LOOP_COUNT</span><span class="p">,</span> <span class="n">totalHitCount</span><span class="p">,</span> <span class="n">endTime</span><span class="o">-</span><span class="n">startTime</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2>NEON : コード解説-処理限界数でのループ</h2>

<p>上記しましたが、この処理でのポイントに「4096ピクセルの処理」というものがあります。これはピクセル数のカウントを１バイトで行い、それを１６個保持しているからです。「２５６(１バイト)ｘ１６＝４０９６」となります。なぜ１バイトで計算するのか？と思われるとおもいますが、これがベクタ演算を使った高速化のカギになります。以下で説明します。</p>

<h2>NEON : コード解説-レジスタの役割</h2>

<p>この最適化コードでは7本のNEON128ビットレジスタを使用しています。それぞれの主な役割は以下のようになります。</p>

<ul>
<li><p>q0(d0,d1): R値を保持</p></li>
<li><p>q1(d2,d3): G値を保持</p></li>
<li><p>q2(d4,d5): B値を保持</p></li>
<li><p>q3(d6,d7): A値を保持。読込むだけで計算には使わない。</p></li>
<li><p>q4(d8,d9): 色判定の結果をカウント</p></li>
<li><p>q5(d10,d11): 色判定で使用する値(0xFFが詰まっている)</p></li>
<li><p>q6(d12,d13): 結果をカウントするときに使用するビットマスク(0x01が詰まっている)</p></li>
</ul>

<h2>NEON : コード解説-データの読込</h2>

<p>まず、計算の前にメモリからNEONレジスタにデータを読み込みます。</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// データの読込と色の加算</span>
<span class="s">&quot;add    r2, %[image], #32 </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;vld4.8 {d0, d2, d4, d6}, [%[image]] </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;vld4.8 {d1, d3, d5, d7}, [r2] </span><span class="se">\n\t</span><span class="s">&quot;</span>
</code></pre></div>
<p>%[image]レジスタがデータの先頭のアドレスを指し、r2レジスタがそこから32バイトずらした8個目以降のピクセルのアドレスを指しています。そして vld4.8 命令を呼び以下の画像のような配置でデータが読み込まれます。</p>

<p><a href="http://www.flickr.com/photos/akiraak/4753801567/"><img src="http://farm5.static.flickr.com/4136/4753801567_2dbe537c9b.jpg" alt="neon_1_registers"></a></p>

<h2>NEON : コード解説-加算</h2>

<p>そして、RGBの値を加算します。</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="s">&quot;vqadd.u8   q0, q1 </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;vqadd.u8   q0, q2 </span><span class="se">\n\t</span><span class="s">&quot;</span>
</code></pre></div>
<p>Rの値が入っている q0 レジスタに、G値の q1 と、B値の q2 を加算します。以下の図ような処理になります。</p>

<p><a href="http://www.flickr.com/photos/akiraak/4754442260/"><img src="http://farm5.static.flickr.com/4096/4754442260_4459bf0609.jpg" alt="neon_2_adding_colors"></a></p>

<p>この時に vadd.u8 ではなく vqadd.u8 を使います。前者は加算時にビットが溢れても気にせずに計算がされます。後者はビットが溢れた場合に最大値が設定されます。計算式でたとえると以下のような違いになります。</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">vadd</span><span class="p">.</span><span class="nl">u8</span>  <span class="p">:</span> <span class="mh">0xFF</span> <span class="o">+</span> <span class="mh">0x01</span> <span class="o">=</span> <span class="mh">0x0</span>
<span class="n">vqadd</span><span class="p">.</span><span class="nl">u8</span>  <span class="p">:</span> <span class="mh">0xFF</span> <span class="o">+</span> <span class="mh">0x01</span> <span class="o">=</span> <span class="mh">0xFF</span>
</code></pre></div>
<p>これで次に行う比較演算が問題なくおこなえます。</p>

<p>しかし、正確にいうと場合によっては問題が大ありです。上記のとおり、この最適化コードでは256以上の値での色判定は行えません。どんな値でも判定できるコードも書いてみたのですが、これがあまり高速化できなかったため今回はバッサリと切り捨てました。</p>

<h2>NEON : コード解説-ピクセルの色チェックとカウント</h2>

<p>ピクセルの色チェックとカウントは多少やっかいなので、図をまじえつつ説明していきます。</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// 色の判定とカウント</span>
<span class="s">&quot;vclt.u8 q1, q0, q5 </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;vand q1, q6 </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;vadd.u8 q4, q4, q1 </span><span class="se">\n\t</span><span class="s">&quot;</span>
</code></pre></div>
<p>vclt.u8 は比較命令です。 RGBの合計値が入っている q0 と、比較用の値を詰め込んである q5 を比較し、 q0 の値の方が小さかった場合に対応するビットに 1 が設定された値を q1 に入れます。意味が分かりにくいと思うので図では以下のようになります。例として q0 にはRGB値が加算されたとして適当な値を入れています。</p>

<p><a href="http://www.flickr.com/photos/akiraak/4754522223/"><img src="http://farm5.static.flickr.com/4073/4754522223_d392487911.jpg" alt="neon_3_vclt"></a></p>

<p>次は、比較判定にヒットしたピクセルをカウントします。vclt.u8 では比較にヒットしたピクセルに対応する箇所のビットが全て立つ、つまり 0xFF が入っています。これを 1 になるように 0x1 で AND を取ります。</p>

<p><a href="http://www.flickr.com/photos/akiraak/4755161406/"><img src="http://farm5.static.flickr.com/4139/4755161406_481562581b.jpg" alt="neon_4_vand"></a></p>

<p>最後に vadd.u8 で q4 に q1 を足してあげれば、１６ピクセル分のカウントが完了します。</p>

<p><a href="http://www.flickr.com/photos/akiraak/4755161338/"><img src="http://farm5.static.flickr.com/4138/4755161338_004e771cdd_b.jpg" alt="neon_5_vadd"></a></p>

<p>上記の図ではカウント用の q4 レジスタが空でしたが、ループを重ねるごとに値が加算されていくことになります。</p>

<h2>NEON : コード解説-カウントの合計</h2>

<p>上記したように、このコードでは4096ピクセルまで計算すると、q4 でのカウンタが最大値である 0xFF になるものが出てきます。ですので、ここで一度別のレジスタに待避させます。</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// 色数の合計</span>
<span class="s">&quot;mov        r0, #0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;vmov.u32   r1, d8[0] </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;2: </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;and        r2, r1, #0xFF </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;add        %[hitCount], r2 </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;lsr        r1, #8 </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;add        r0, #1 </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;cmp    r0, #4 </span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="s">&quot;bne        2b </span><span class="se">\n\t</span><span class="s">&quot;</span>

<span class="c1">//以下の同様の処理は省略</span>
</code></pre></div>
<p>まず vmov.u32 で d8<a href="d8%E3%81%AE%E4%B8%8A%E4%BD%8D4%E3%83%90%E3%82%A4%E3%83%88">0</a> を r1 レジスタにコピーします。and で 下位１バイトに格納されているカウンタを取り出し %[hitCount] に足します。lsr r1, #8 で１バイト分右にシフトし次のカウンタの値を取得する準備をします。and と lsr の処理は以下の図のようになります。</p>

<p><a href="http://www.flickr.com/photos/akiraak/4754521753/"><img src="http://farm5.static.flickr.com/4094/4754521753_9d7e894a5c_o.jpg" alt="neon_6_shift_count"></a></p>

<p>これらの処理をループで４回まわして、合計４個のカウント値を合計します。</p>

<p>その後 d8[1] d9[0] d9[1] にも同様の処理を行ない、16個を合計します。</p>

<p>これまでの処理を画像データの最後まで繰り返すと、RGB合計値が256未満の色をもつピクセル（黒っぽいピクセル）の個数が、C言語で書いたプログラムの約４倍の速度で取得できます。</p>

<h2>終りに</h2>

<p>今回最適化を行うにあたって上記のコード量の１０倍程度を書き検証しました。そこで分かった注意点が、NEONで最適化するなら、メモリロードなどにARMレジスタや命令を使わずに、直接NEONレジスタと命令を使わないと意味が無いという事です。</p>

<p>決して汎用的な最適化コードではないですが、iPhoneで大量の処理を行う必要がある場合に、NEONでの高速化は有効だと思います。その時の参考になれば幸いです。</p>

<p>最後に、NEONを使いながらC言語の処理速度とほぼ同じだったコードを書いておきます。</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define IMAGE_SIZE_W        (1024)</span>
<span class="cp">#define IMAGE_SIZE_H        (768)</span>
<span class="cp">#define CHECK_COLOR     (0xFF)</span>
<span class="cp">#define LOOP_COUNT      (100)</span>
<span class="cp">#define ELEMENT_OF_PIXEL    (4)</span>

<span class="n">NSString</span><span class="o">*</span> <span class="n">Test</span><span class="o">::</span><span class="n">testNeon</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">pixelCount</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">totalHitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">checkColor</span> <span class="o">=</span> <span class="n">CHECK_COLOR</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LOOP_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">hitCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">__asm__</span> <span class="nf">volatile</span> <span class="p">(</span>
                <span class="c1">// 初期化</span>
                <span class="s">&quot;mov    r0, #0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov.u32 d8, r0, r0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov.u32 d9, r0, r0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov.u32 d6, %[checkColor], %[checkColor] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov.u32 d7, %[checkColor], %[checkColor] </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="c1">// ループ開始</span>
                <span class="s">&quot;1: </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;add    r0, r0, #4 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="s">&quot;ldrb r1, [%[image]] </span><span class="se">\n\t</span><span class="s">&quot;</span>  
                <span class="s">&quot;ldrb r2, [%[image], #1] </span><span class="se">\n\t</span><span class="s">&quot;</span>  
                <span class="s">&quot;ldrb r3, [%[image], #2] </span><span class="se">\n\t</span><span class="s">&quot;</span>  

                <span class="s">&quot;ldrb r4, [%[image], #4] </span><span class="se">\n\t</span><span class="s">&quot;</span>  
                <span class="s">&quot;ldrb r5, [%[image], #5] </span><span class="se">\n\t</span><span class="s">&quot;</span>  
                <span class="s">&quot;ldrb r6, [%[image], #6] </span><span class="se">\n\t</span><span class="s">&quot;</span>  

                <span class="s">&quot;vmov d0, r1, r4 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov d2, r2, r5 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov d4, r3, r6 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="s">&quot;ldrb r1, [%[image], #8] </span><span class="se">\n\t</span><span class="s">&quot;</span>  
                <span class="s">&quot;ldrb r2, [%[image], #9] </span><span class="se">\n\t</span><span class="s">&quot;</span>  
                <span class="s">&quot;ldrb r3, [%[image], #10] </span><span class="se">\n\t</span><span class="s">&quot;</span>  

                <span class="s">&quot;ldrb r4, [%[image], #12] </span><span class="se">\n\t</span><span class="s">&quot;</span>  
                <span class="s">&quot;ldrb r5, [%[image], #13] </span><span class="se">\n\t</span><span class="s">&quot;</span>  
                <span class="s">&quot;ldrb r6, [%[image], #14] </span><span class="se">\n\t</span><span class="s">&quot;</span>  

                <span class="s">&quot;vmov d1, r1, r4 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov d3, r2, r5 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov d5, r3, r6 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="s">&quot;add %[image], %[image], #16 </span><span class="se">\n\t</span><span class="s">&quot;</span>  

                <span class="s">&quot;vadd.s32   q0, q0, q1 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vadd.s32   q0, q0, q2 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="c1">// カウント</span>
                <span class="s">&quot;vclt.s32 q1, q0, q3 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vsub.s32 q4, q4, q1 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="c1">// 「ループ開始」へ</span>
                <span class="s">&quot;cmp    r0, %[pixelCount] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;bcc    1b </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="c1">// 色判定とカウント</span>
                <span class="s">&quot;vmov.s32 %[hitCount], d8[0] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov.s32 r0, d8[1] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov.s32 r1, d9[0] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;vmov.s32 r2, d9[1] </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;add %[hitCount], r0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;add %[hitCount], r1 </span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;add %[hitCount], r2 </span><span class="se">\n\t</span><span class="s">&quot;</span>

                <span class="o">:</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="p">[</span><span class="n">hitCount</span><span class="p">]</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">hitCount</span><span class="p">)</span>
                <span class="o">:</span> <span class="p">[</span><span class="n">pixelCount</span><span class="p">]</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">pixelCount</span><span class="p">),</span> <span class="p">[</span><span class="n">image</span><span class="p">]</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="p">[</span><span class="n">checkColor</span><span class="p">]</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">checkColor</span><span class="p">)</span>
                <span class="o">:</span> <span class="s">&quot;r0&quot;</span><span class="p">,</span> <span class="s">&quot;r1&quot;</span><span class="p">,</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;r3&quot;</span><span class="p">,</span> <span class="s">&quot;r4&quot;</span><span class="p">,</span> <span class="s">&quot;r5&quot;</span><span class="p">,</span> <span class="s">&quot;r6&quot;</span><span class="p">,</span> <span class="s">&quot;q0&quot;</span><span class="p">,</span> <span class="s">&quot;q1&quot;</span><span class="p">,</span> <span class="s">&quot;q2&quot;</span><span class="p">,</span> <span class="s">&quot;q3&quot;</span><span class="p">,</span> <span class="s">&quot;q4&quot;</span><span class="p">,</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span>
                <span class="p">);</span>
        <span class="n">totalHitCount</span> <span class="o">+=</span> <span class="n">hitCount</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>
    <span class="n">NSString</span><span class="o">*</span> <span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="err">@</span><span class="s">&quot;Pixcel: %d</span><span class="se">\n</span><span class="s">Hit Pixel: %d</span><span class="se">\n</span><span class="s">Time: %d msec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixelCount</span> <span class="o">*</span> <span class="n">LOOP_COUNT</span><span class="p">,</span> <span class="n">totalHitCount</span><span class="p">,</span> <span class="n">endTime</span><span class="o">-</span><span class="n">startTime</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
    </div>
  </div>

  
  <div class="related">
    <h4>Related Posts</h2>
    <ul class="posts">
        
        <li>
        <span>28 Jun 2013 &raquo;</span>
        <a href="http://moonshine-project.com//ja/2013/06/28/titanium-iphone-android-crossplatform-gotchas/">iPhone向けに作られたTitaniumアプリのAndroid対応で気をつけること</a>
        </li>
        
        <li>
        <span>18 Apr 2013 &raquo;</span>
        <a href="http://moonshine-project.com//ja/2013/04/18/mynovel-on-github/">小説を２倍に拡大表示してくれる「吾輩の小説」のコードを公開</a>
        </li>
        
        <li>
        <span>25 May 2010 &raquo;</span>
        <a href="http://moonshine-project.com//ja/2010/05/25/best-way-to-cut-books-for-scanning/">分厚いハードカバーの本をカッターで綺麗に裁断する方法</a>
        </li>
        
    </ul>
  </div>
  

  <div class="post-footer" layout="horizontal">
    <div flex="33" class="post-footer-prev">
      
        <a href="http://moonshine-project.com//ja/2010/05/25/best-way-to-cut-books-for-scanning/"><< Older</a>
      
    </div>
    <div flex="33" class="post-footer-home"><a href="http://moonshine-project.com// ">Home</a></div>
    <div flex="33" class="post-footer-next">
      
        <a href="http://moonshine-project.com//ja/2013/04/18/mynovel-on-github/">Newer >></a>
      
    </div>
  </div>
</div>
 

        </div>
      </md-content>
    </div>
    <script src="/bower_components/angular/angular.js"></script>
    <script src="/bower_components/angular-aria/angular-aria.js"></script>
    <script src="/bower_components/angular-animate/angular-animate.js"></script>
    <script src="/bower_components/hammerjs/hammer.js"></script>
    <script src="/bower_components/angular-material/angular-material.js"></script>
    <script src="/assets/js/main.js"></script>
    
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-536501-6']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  </body>        
</html>
